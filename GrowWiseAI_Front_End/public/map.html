<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USA Map Click + Side Panel</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    /* =========================
       THEME TOKENS
       ========================= */
    :root {
      --bg: #0b1220;
      --panel: #0f1a33;
      --panel2: #0b1224;
      --border: #223056;
      --text: #e6edf7;
      --muted: #9bb0d0;

      --good: #22c55e;
      --bad:  #ef4444;
      --warn: #f59e0b;

      --chip: rgba(255,255,255,0.06);
      --shadow: 0 12px 30px rgba(0,0,0,0.35);

      --card-bg: rgba(0,0,0,0.18);
      --toast-bg: rgba(15, 26, 51, 0.95);

      --skeleton: rgba(255,255,255,0.08);
      --skeleton2: rgba(255,255,255,0.14);
    }

    body.light {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel2: #f4f6ff;
      --border: #d6def1;
      --text: #101828;
      --muted: #5d6b8a;

      --chip: rgba(16,24,40,0.06);
      --shadow: 0 12px 30px rgba(16,24,40,0.12);

      --card-bg: rgba(16,24,40,0.03);
      --toast-bg: rgba(255,255,255,0.95);

      --skeleton: rgba(16,24,40,0.06);
      --skeleton2: rgba(16,24,40,0.10);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      height: 100vh;
      display: grid;
      grid-template-columns: 1fr 420px;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* =========================
       MAP POLISH
       ========================= */
    /* Cursor states (toggled via JS). */
    .leaflet-container.cursor-inside {
      cursor: crosshair;
    }
    .leaflet-container.cursor-outside {
      /* A crisp ‚ÄúX‚Äù cursor using an inline SVG. */
      cursor: url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%3E%3Cpath%20d='M6%206%2018%2018M18%206%206%2018'%20stroke='%23ef4444'%20stroke-width='3'%20stroke-linecap='round'/%3E%3C/svg%3E") 12 12, not-allowed;
    }

    /* Style Leaflet controls to match the panel theme (no plugins needed). */
    .leaflet-control-zoom a,
    .leaflet-control-layers-toggle,
    .leaflet-control-scale {
      background: var(--toast-bg) !important;
      border: 1px solid var(--border) !important;
      box-shadow: var(--shadow) !important;
      color: var(--text) !important;
    }
    .leaflet-control-zoom a:hover {
      filter: brightness(1.07);
    }
    .leaflet-control-attribution {
      background: transparent !important;
      color: var(--muted) !important;
    }

    .panel {
      border-left: 1px solid var(--border);
      background: var(--panel);
      padding: 16px;
      overflow: auto;
    }

    .topbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title {
      font-size: 18px;
      font-weight: 800;
      margin: 0;
      letter-spacing: 0.2px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .pill-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      font-weight: 700;
      color: var(--text);
    }

    .badge.good { color: var(--good); }
    .badge.bad { color: var(--bad); }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing: 0.2px;
      color: var(--muted);
      font-weight: 800;
      text-transform: uppercase;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      font-size: 14px;
    }

    .k { color: var(--muted); display: inline-flex; align-items:center; gap: 8px; }
    .v { font-variant-numeric: tabular-nums; }

    .btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .btns-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      transition: transform 0.05s ease, background 0.2s ease;
    }
    button:hover { background: rgba(11, 18, 36, 0.85); }
    body.light button:hover { background: rgba(244, 246, 255, 0.9); }
    button:active { transform: translateY(1px); }

    button.primary {
      border-color: rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.10);
    }
    button.primary:hover { background: rgba(34,197,94,0.16); }

    button.warn {
      border-color: rgba(245,158,11,0.35);
      background: rgba(245,158,11,0.10);
    }
    button.warn:hover { background: rgba(245,158,11,0.16); }

    button.ghost {
      background: transparent;
    }
    button.ghost:hover { background: var(--chip); }

    input[type="number"] {
      width: 120px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      font-weight: 650;
    }

    input[type="range"] {
      width: 180px;
      accent-color: #60a5fa;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.35;
    }

    /* Tooltip */
    .help {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-grid;
      place-items: center;
      font-size: 12px;
      font-weight: 900;
      background: var(--chip);
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: default;
      position: relative;
    }

    .help[data-tip]:hover::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 26px;
      background: var(--toast-bg);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 10px;
      width: 240px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      font-size: 12px;
      line-height: 1.25;
      z-index: 9999;
      pointer-events: none;
    }

    /* Mini bar chart */
    .bars {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }
    .bar-row {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }
    .bar-label { color: var(--muted); }
    .bar-wrap {
      height: 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(96,165,250,0.9), rgba(34,197,94,0.85));
      border-radius: 999px;
      transition: width 0.4s ease;
    }

    .explain-text {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 10px 0;
      opacity: 0.9;
    }

    /* Skeleton loading */
    .skeleton {
      border-radius: 12px;
      background: linear-gradient(
        90deg,
        var(--skeleton) 0%,
        var(--skeleton2) 50%,
        var(--skeleton) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-line { height: 12px; margin: 8px 0; }
    .skeleton-line.sm { width: 60%; }
    .skeleton-line.md { width: 78%; }
    .skeleton-line.lg { width: 92%; }

    /* Toast */
    .toast {
      position: fixed;
      left: 16px;
      bottom: 16px;
      z-index: 10000;
      background: var(--toast-bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      min-width: 240px;
      max-width: 360px;
      display: none;
    }
    .toast.show { display: block; }
    .toast .t-title { font-weight: 900; margin: 0 0 4px; font-size: 13px; }
    .toast .t-body { margin: 0; font-size: 12px; color: var(--muted); line-height: 1.3; }

    /* Leaflet compass (simple) */
    .compass {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: var(--toast-bg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: grid;
      place-items: center;
      font-weight: 1000;
      color: var(--text);
      user-select: none;
    }
    .compass small {
      display:block;
      margin-top: -2px;
      font-size: 10px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    /* Responsive */
    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .panel { height: 44vh; border-left: none; border-top: 1px solid var(--border); }
      #map { height: 56vh; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="map"></div>

    <aside class="panel">
      <div class="topbar">
        <div>
          <h1 class="title">Reforestation DSS</h1>
          <p class="sub">
            Click a location in the USA. We‚Äôll later fetch environmental values within a radius,
            run the model, and show survivability + a clear explanation.
          </p>

          <div class="pill-row">
            <span class="pill">
              <span class="badge" id="usaBadge">‚Äî</span>
              <span id="usaBadgeText">No selection yet</span>
            </span>
            <span class="pill">
              Radius default: <span class="badge" id="radiusBadge">10 km</span>
            </span>
          </div>
        </div>

        <button id="themeBtn" class="ghost" title="Toggle light/dark">üåô</button>
      </div>

      <!-- Location card -->
      <div class="card">
        <h3>Location</h3>

        <div class="row">
          <span class="k">Selected lat</span>
          <span class="v" id="latOut">‚Äî</span>
        </div>
        <div class="row">
          <span class="k">Selected lon</span>
          <span class="v" id="lonOut">‚Äî</span>
        </div>

        <div class="divider"></div>

        <div class="row">
          <span class="k">
            Radius (km)
            <span class="help" data-tip="Search radius for nearby environmental values. We‚Äôll later average (or select nearest) values inside this circle.">?</span>
          </span>
          <span class="v">
            <input id="radiusInput" type="number" min="1" max="200" step="1" />
          </span>
        </div>

        <div class="btns">
          <button id="clearBtn">Clear</button>
          <button id="centerBtn">Center USA</button>
        </div>

        <div class="btns-3">
          <button id="resetBtn" class="warn">Reset defaults</button>
          <button id="copyLinkBtn" class="ghost">Copy link</button>
          <button id="predictBtn" class="primary">Predict</button>
        </div>

        <div class="hint">
          Tip: ‚ÄúCopy link‚Äù makes a shareable URL with lat/lon/radius + slider values.
        </div>
      </div>

      <!-- Factors card -->
      <div class="card">
        <h3>Factors (demo sliders)</h3>

        <div class="row">
          <span class="k">
            Elevation (m)
            <span class="help" data-tip="Elevation above sea level (meters). Affects temperature, moisture, and species suitability.">?</span>
          </span>
          <span class="v">
            <input id="elevRange" type="range" min="0" max="3000" step="10" />
            <span id="elevVal">‚Äî</span>
          </span>
        </div>

        <div class="row">
          <span class="k">
            Temperature (¬∞C)
            <span class="help" data-tip="Average temperature (¬∞C). Too hot/cold can reduce survivability depending on species.">?</span>
          </span>
          <span class="v">
            <input id="tempRange" type="range" min="-10" max="40" step="0.5" />
            <span id="tempVal">‚Äî</span>
          </span>
        </div>

        <div class="row">
          <span class="k">
            Humidity (%)
            <span class="help" data-tip="Relative humidity (%). Low humidity can increase drought stress; high can raise disease risk.">?</span>
          </span>
          <span class="v">
            <input id="humRange" type="range" min="0" max="100" step="1" />
            <span id="humVal">‚Äî</span>
          </span>
        </div>

        <div class="row">
          <span class="k">
            Soil TN (g/kg)
            <span class="help" data-tip="Total Nitrogen: a proxy for fertility. Low TN often limits growth. Units here are demo (g/kg).">?</span>
          </span>
          <span class="v">
            <input id="tnRange" type="range" min="0" max="10" step="0.1" />
            <span id="tnVal">‚Äî</span>
          </span>
        </div>

        <div class="row">
          <span class="k">
            Soil TP (g/kg)
            <span class="help" data-tip="Total Phosphorus: supports roots and energy transfer. Low TP can reduce establishment. Units here are demo (g/kg).">?</span>
          </span>
          <span class="v">
            <input id="tpRange" type="range" min="0" max="5" step="0.05" />
            <span id="tpVal">‚Äî</span>
          </span>
        </div>

        <div class="row">
          <span class="k">
            Fire risk (0‚Äì1)
            <span class="help" data-tip="Composite risk index (0‚Äì1). Higher means higher risk of wildfire stress/damage.">?</span>
          </span>
          <span class="v">
            <input id="fireRange" type="range" min="0" max="1" step="0.01" />
            <span id="fireVal">‚Äî</span>
          </span>
        </div>
      </div>

      <!-- Explainability card -->
      <div class="card">
        <h3>Explain why</h3>
        <div id="explainBox">
          <div class="hint">Click ‚ÄúPredict‚Äù to generate a demo explanation (placeholder until model/SHAP).</div>
        </div>
      </div>

      <!-- Debug -->
      <div class="card">
        <h3>Debug payload</h3>
        <pre id="payloadOut" style="margin:0; white-space: pre-wrap;"></pre>
      </div>
    </aside>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <p class="t-title" id="toastTitle">Notice</p>
    <p class="t-body" id="toastBody">‚Ä¶</p>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /*********************************************************
     * EASY GLOBALS (edit later)
     *********************************************************/
    let CLICK_RADIUS_KM = 10;
    const USA_CENTER = [39.5, -98.35];
    const USA_ZOOM = 4;

    // Rough USA bounds (good enough for a hackathon guardrail)
    // (minLat, maxLat, minLon, maxLon)
    const USA_BOUNDS = { minLat: 24.396308, maxLat: 49.384358, minLon: -124.848974, maxLon: -66.885444 };

    // ‚ÄúExact USA‚Äù guardrail (Polygon/MultiPolygon). If this fails to load,
    // we gracefully fall back to the rough bounds above.
    const USA_GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries/USA.geo.json";
    let usaGeo = null;

    // Default slider values (demo)
    const DEFAULTS = {
      lat: null,
      lon: null,
      radius_km: 10,
      elevation_m: 300,
      temperature_c: 15,
      humidity_pct: 55,
      soil_tn: 2.5,
      soil_tp: 0.8,
      fire_risk_index: 0.25,
    };

    /*********************************************************
     * MAP SETUP
     *********************************************************/
    const map = L.map("map", { zoomControl: true }).setView(USA_CENTER, USA_ZOOM);

    // Base tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Greyscale overlay tiles to ‚Äúgrey out‚Äù everything,
    // then we draw a "USA window" rectangle with normal tiles on top.
    // This creates a strong ‚ÄúUSA-only‚Äù feel without needing country polygons.
    const grayLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 19,
      opacity: 0.85,
      attribution: '&copy; OpenStreetMap contributors, &copy; CARTO'
    }).addTo(map);

    const usaTiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      opacity: 1.0,
      attribution: '&copy; OpenStreetMap contributors'
    });

    // Create a "pane" and clip-like effect using bounds (approx window).
    // We just add a rectangle border + add USA tiles;
    // outside will still look grey because the grey tiles are under everything.
    usaTiles.addTo(map);

    // Draw a subtle USA bounds box to communicate limitation
    const usaRect = L.rectangle(
      [[USA_BOUNDS.minLat, USA_BOUNDS.minLon], [USA_BOUNDS.maxLat, USA_BOUNDS.maxLon]],
      { color: "#60a5fa", weight: 1, fillOpacity: 0 }
    ).addTo(map);

    // Compass control
    const CompassControl = L.Control.extend({
      onAdd: function() {
        const div = L.DomUtil.create('div');
        div.className = 'compass';
        div.innerHTML = 'N<small>compass</small>';
        return div;
      },
      onRemove: function() {}
    });
    map.addControl(new CompassControl({ position: 'topright' }));

    // Scale bar (built-in Leaflet control)
    L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

    // Selection layers
    let clickMarker = null;
    let clickCircle = null;

    /*********************************************************
     * UI refs
     *********************************************************/
    const latOut = document.getElementById("latOut");
    const lonOut = document.getElementById("lonOut");
    const payloadOut = document.getElementById("payloadOut");
    const statusOut = { set: (s) => showToast("Status", s, 1400) }; // toast-only status (clean UI)

    const radiusInput = document.getElementById("radiusInput");
    const radiusBadge = document.getElementById("radiusBadge");

    const usaBadge = document.getElementById("usaBadge");
    const usaBadgeText = document.getElementById("usaBadgeText");

    const elevRange = document.getElementById("elevRange");
    const tempRange = document.getElementById("tempRange");
    const humRange  = document.getElementById("humRange");
    const tnRange   = document.getElementById("tnRange");
    const tpRange   = document.getElementById("tpRange");
    const fireRange = document.getElementById("fireRange");

    const elevVal = document.getElementById("elevVal");
    const tempVal = document.getElementById("tempVal");
    const humVal  = document.getElementById("humVal");
    const tnVal   = document.getElementById("tnVal");
    const tpVal   = document.getElementById("tpVal");
    const fireVal = document.getElementById("fireVal");

    const explainBox = document.getElementById("explainBox");

    /*********************************************************
     * Toast helpers
     *********************************************************/
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastBody = document.getElementById("toastBody");
    let toastTimer = null;

    function showToast(title, body, ms = 2200) {
      toastTitle.textContent = title;
      toastBody.textContent = body;
      toast.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
    }

    /*********************************************************
     * Helpers
     *********************************************************/
    function kmToMeters(km) { return km * 1000; }

    function isInsideUSABounds(lat, lon) {
      return (
        lat >= USA_BOUNDS.minLat &&
        lat <= USA_BOUNDS.maxLat &&
        lon >= USA_BOUNDS.minLon &&
        lon <= USA_BOUNDS.maxLon
      );
    }

    // Ray-casting point-in-ring test.
    // pt = [lon, lat], ring = [[lon,lat], ...]
    function pointInRing(pt, ring) {
      let inside = false;
      for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
        const xi = ring[i][0];
        const yi = ring[i][1];
        const xj = ring[j][0];
        const yj = ring[j][1];

        const intersect = ((yi > pt[1]) !== (yj > pt[1])) &&
          (pt[0] < (xj - xi) * (pt[1] - yi) / ((yj - yi) || 1e-12) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    // Polygon = [outerRing, holeRing1, holeRing2, ...]
    function pointInPolygon(pt, polygon) {
      if (!polygon || polygon.length === 0) return false;
      if (!pointInRing(pt, polygon[0])) return false;
      for (let i = 1; i < polygon.length; i++) {
        if (pointInRing(pt, polygon[i])) return false; // inside a hole
      }
      return true;
    }

    function pointInGeoJSON(pt, geojson) {
      if (!geojson) return false;
      const geom = geojson.type === "Feature" ? geojson.geometry
        : geojson.type === "FeatureCollection" ? (geojson.features[0] && geojson.features[0].geometry)
        : geojson;

      if (!geom) return false;

      if (geom.type === "Polygon") {
        return pointInPolygon(pt, geom.coordinates);
      }

      if (geom.type === "MultiPolygon") {
        for (const poly of geom.coordinates) {
          if (pointInPolygon(pt, poly)) return true;
        }
        return false;
      }

      return false;
    }

    function isInsideUSA(lat, lon) {
      // Quick reject for speed, even when using exact polygon.
      if (!isInsideUSABounds(lat, lon)) return false;
      if (!usaGeo) return true; // bounds-only until polygon loads
      return pointInGeoJSON([lon, lat], usaGeo);
    }

    async function loadUSABoundary() {
      try {
        const res = await fetch(USA_GEOJSON_URL, { cache: "force-cache" });
        if (!res.ok) throw new Error(String(res.status));
        usaGeo = await res.json();
        // Small UI hint only once.
        showToast("USA boundary loaded", "Cursor + clicks now use the exact USA outline.", 1800);
      } catch {
        usaGeo = null;
        // Keep quiet: bounds fallback is fine.
      }
    }

    function setUSABadge(lat, lon) {
      if (lat == null || lon == null) {
        usaBadge.textContent = "‚Äî";
        usaBadge.className = "badge";
        usaBadgeText.textContent = "No selection yet";
        return;
      }

      const ok = isInsideUSA(lat, lon);
      usaBadge.textContent = ok ? "‚úÖ Inside USA" : "‚õî Outside USA";
      usaBadge.className = "badge " + (ok ? "good" : "bad");
      usaBadgeText.textContent = ok ? "Allowed (for now)" : "Off-limits for now";
    }

    function setCoords(lat, lon) {
      latOut.textContent = lat.toFixed(6);
      lonOut.textContent = lon.toFixed(6);
      setUSABadge(lat, lon);
      updatePayload(lat, lon);
    }

    function drawSelection(lat, lon) {
      if (clickMarker) clickMarker.remove();
      clickMarker = L.marker([lat, lon]).addTo(map);

      if (clickCircle) clickCircle.remove();
      clickCircle = L.circle([lat, lon], {
        radius: kmToMeters(CLICK_RADIUS_KM),
        color: "#60a5fa",
        weight: 2,
        fillColor: "#60a5fa",
        fillOpacity: 0.12
      }).addTo(map);
    }

    function clearSelection() {
      if (clickMarker) clickMarker.remove();
      if (clickCircle) clickCircle.remove();
      clickMarker = null;
      clickCircle = null;

      latOut.textContent = "‚Äî";
      lonOut.textContent = "‚Äî";
      payloadOut.textContent = "";
      setUSABadge(null, null);
    }

    function readFactors() {
      return {
        elevation_m: Number(elevRange.value),
        temperature_c: Number(tempRange.value),
        humidity_pct: Number(humRange.value),
        soil_tn: Number(tnRange.value),
        soil_tp: Number(tpRange.value),
        fire_risk_index: Number(fireRange.value),
      };
    }

    function updateFactorLabels() {
      elevVal.textContent = `${Number(elevRange.value).toFixed(0)}`;
      tempVal.textContent = `${Number(tempRange.value).toFixed(1)}`;
      humVal.textContent  = `${Number(humRange.value).toFixed(0)}`;
      tnVal.textContent   = `${Number(tnRange.value).toFixed(1)}`;
      tpVal.textContent   = `${Number(tpRange.value).toFixed(2)}`;
      fireVal.textContent = `${Number(fireRange.value).toFixed(2)}`;
    }

    function updatePayload(lat, lon) {
      const f = readFactors();
      const payload = {
        lat: lat != null ? Number(lat.toFixed(6)) : null,
        lon: lon != null ? Number(lon.toFixed(6)) : null,
        radius_km: CLICK_RADIUS_KM,
        ...f
      };
      payloadOut.textContent = JSON.stringify(payload, null, 2);
    }

    /*********************************************************
     * Explainability (demo)
     * Replace later with: feature importance + SHAP
     *********************************************************/
    function buildExplainabilityDemo() {
      // Simple heuristic just for demo:
      // High fire risk and very low nutrients become "negatives".
      // Moderate temp/humidity become "positives".
      const f = readFactors();

      const neg = [];
      const pos = [];

      if (f.fire_risk_index > 0.6) neg.push("high fire risk");
      else pos.push("manageable fire risk");

      if (f.soil_tn < 1.2) neg.push("low soil nitrogen");
      else pos.push("adequate nitrogen");

      if (f.soil_tp < 0.4) neg.push("low soil phosphorus");
      else pos.push("adequate phosphorus");

      if (f.humidity_pct < 25) neg.push("very low humidity");
      else if (f.humidity_pct > 85) neg.push("very high humidity");
      else pos.push("moderate humidity");

      if (f.temperature_c < 0) neg.push("very low temperature");
      else if (f.temperature_c > 32) neg.push("very high temperature");
      else pos.push("moderate temperature");

      // Fake ‚Äútop 5 factor strengths‚Äù (0..100) for bar chart
      // You can swap these with real importances later.
      const bars = [
        { name: "Fire risk", val: Math.round((1 - f.fire_risk_index) * 100) },
        { name: "Soil TN", val: Math.round(Math.min(1, f.soil_tn / 5) * 100) },
        { name: "Soil TP", val: Math.round(Math.min(1, f.soil_tp / 2) * 100) },
        { name: "Humidity", val: Math.round(100 - Math.min(100, Math.abs(f.humidity_pct - 55) * 2)) },
        { name: "Temp", val: Math.round(100 - Math.min(100, Math.abs(f.temperature_c - 16) * 4)) },
      ];

      // Sort descending
      bars.sort((a, b) => b.val - a.val);

      return { bars, neg, pos };
    }

    function renderExplainabilityLoading() {
      explainBox.innerHTML = `
        <div class="skeleton skeleton-line lg"></div>
        <div class="skeleton skeleton-line md"></div>
        <div class="skeleton skeleton-line sm"></div>
        <div style="height:10px"></div>
        <div class="skeleton skeleton-line lg"></div>
        <div class="skeleton skeleton-line md"></div>
        <div class="skeleton skeleton-line sm"></div>
      `;
    }

    function renderExplainabilityResult() {
      const { bars, neg, pos } = buildExplainabilityDemo();

      const barHtml = bars.slice(0, 5).map((b) => `
        <div class="bar-row">
          <div class="bar-label">${b.name}</div>
          <div class="bar-wrap"><div class="bar-fill" style="width:${b.val}%"></div></div>
        </div>
      `).join("");

      const negText = neg.length ? neg.join(", ") : "none detected";
      const posText = pos.length ? pos.join(", ") : "none detected";

      explainBox.innerHTML = `
        <div class="bars">${barHtml}</div>
        <div class="explain-text">
          <strong>Main negatives:</strong> ${negText}<br/>
          <strong>Main positives:</strong> ${posText}
          <div class="hint" style="margin-top:10px;">
            Demo explanation. Later replace with real feature importance + SHAP.
          </div>
        </div>
      `;
    }

    /*********************************************************
     * URL share link (query params)
     *********************************************************/
    function setURLFromState(lat, lon) {
      const f = readFactors();
      const u = new URL(window.location.href);
      if (lat != null && lon != null) {
        u.searchParams.set("lat", lat.toFixed(6));
        u.searchParams.set("lon", lon.toFixed(6));
      }
      u.searchParams.set("r", String(CLICK_RADIUS_KM));
      u.searchParams.set("elev", String(f.elevation_m));
      u.searchParams.set("temp", String(f.temperature_c));
      u.searchParams.set("hum", String(f.humidity_pct));
      u.searchParams.set("tn", String(f.soil_tn));
      u.searchParams.set("tp", String(f.soil_tp));
      u.searchParams.set("fire", String(f.fire_risk_index));
      history.replaceState(null, "", u.toString());
      return u.toString();
    }

    async function copyShareLink() {
      const lat = clickMarker ? clickMarker.getLatLng().lat : null;
      const lon = clickMarker ? clickMarker.getLatLng().lng : null;
      const url = setURLFromState(lat, lon);
      try {
        await navigator.clipboard.writeText(url);
        showToast("Copied link ‚úÖ", "Share this exact scenario URL.");
      } catch {
        showToast("Copy failed", "Your browser blocked clipboard. Manually copy from address bar.");
      }
    }

    function loadStateFromURL() {
      const u = new URL(window.location.href);
      const lat = u.searchParams.get("lat");
      const lon = u.searchParams.get("lon");
      const r   = u.searchParams.get("r");

      const elev = u.searchParams.get("elev");
      const temp = u.searchParams.get("temp");
      const hum  = u.searchParams.get("hum");
      const tn   = u.searchParams.get("tn");
      const tp   = u.searchParams.get("tp");
      const fire = u.searchParams.get("fire");

      if (r) {
        const rv = Number(r);
        if (Number.isFinite(rv) && rv > 0) CLICK_RADIUS_KM = rv;
      }

      // sliders
      if (elev) elevRange.value = elev;
      if (temp) tempRange.value = temp;
      if (hum)  humRange.value  = hum;
      if (tn)   tnRange.value   = tn;
      if (tp)   tpRange.value   = tp;
      if (fire) fireRange.value = fire;

      radiusInput.value = CLICK_RADIUS_KM;
      radiusBadge.textContent = `${CLICK_RADIUS_KM} km`;
      updateFactorLabels();

      // coords (only place marker if inside USA)
      if (lat && lon) {
        const la = Number(lat);
        const lo = Number(lon);
        if (Number.isFinite(la) && Number.isFinite(lo)) {
          if (isInsideUSA(la, lo)) {
            drawSelection(la, lo);
            setCoords(la, lo);
            map.setView([la, lo], Math.max(USA_ZOOM, 6));
          } else {
            setUSABadge(la, lo);
          }
        }
      } else {
        setUSABadge(null, null);
      }
    }

    /*********************************************************
     * Theme toggle
     *********************************************************/
    const themeBtn = document.getElementById("themeBtn");

    function setTheme(mode) {
      if (mode === "light") {
        document.body.classList.add("light");
        themeBtn.textContent = "‚òÄÔ∏è";
        themeBtn.title = "Switch to dark mode";
        // Map background: light outside-USA layer.
        grayLayer.setUrl("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png");
        grayLayer.setOpacity(0.85);
        localStorage.setItem("theme", "light");
      } else {
        document.body.classList.remove("light");
        themeBtn.textContent = "üåô";
        themeBtn.title = "Switch to light mode";
        // Map background: dark outside-USA layer (makes the USA pop).
        grayLayer.setUrl("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png");
        grayLayer.setOpacity(0.88);
        localStorage.setItem("theme", "dark");
      }
    }

    /*********************************************************
     * Wire up interactions
     *********************************************************/
    // Init
    radiusInput.value = CLICK_RADIUS_KM;
    radiusBadge.textContent = `${CLICK_RADIUS_KM} km`;

    // slider defaults
    elevRange.value = DEFAULTS.elevation_m;
    tempRange.value = DEFAULTS.temperature_c;
    humRange.value  = DEFAULTS.humidity_pct;
    tnRange.value   = DEFAULTS.soil_tn;
    tpRange.value   = DEFAULTS.soil_tp;
    fireRange.value = DEFAULTS.fire_risk_index;
    updateFactorLabels();

    // apply theme
    setTheme(localStorage.getItem("theme") || "dark");
    themeBtn.addEventListener("click", () => {
      const isLight = document.body.classList.contains("light");
      setTheme(isLight ? "dark" : "light");
    });

    // Load the exact USA boundary in the background (falls back silently if it fails).
    loadUSABoundary();

    // map click: USA-only guardrail
    map.on("click", (e) => {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;

      if (!isInsideUSA(lat, lon)) {
        setUSABadge(lat, lon);
        showToast("Off-limits ‚õî", "We‚Äôre USA-only for now. Click inside the blue boundary box.");
        return;
      }

      drawSelection(lat, lon);
      setCoords(lat, lon);
      showToast("Selected ‚úÖ", "Location saved. Adjust sliders or hit Predict.");
      setURLFromState(lat, lon);
    });

    // Cursor UX: show a red ‚ÄúX‚Äù when the pointer is outside the USA.
    // (Uses exact USA outline once USA geojson loads; otherwise falls back to bounds.)
    const mapEl = map.getContainer();
    mapEl.classList.add("cursor-inside");
    let moveRaf = 0;
    let lastMove = null;

    function updateMapCursor(ll) {
      if (!ll) return;
      const inside = isInsideUSA(ll.lat, ll.lng);
      mapEl.classList.toggle("cursor-inside", inside);
      mapEl.classList.toggle("cursor-outside", !inside);
    }

    map.on("mousemove", (e) => {
      lastMove = e.latlng;
      if (moveRaf) return;
      moveRaf = requestAnimationFrame(() => {
        updateMapCursor(lastMove);
        moveRaf = 0;
      });
    });

    map.on("mouseout", () => {
      mapEl.classList.remove("cursor-inside");
      mapEl.classList.remove("cursor-outside");
    });

    // radius
    radiusInput.addEventListener("input", () => {
      const v = Number(radiusInput.value);
      if (!Number.isFinite(v) || v <= 0) return;
      CLICK_RADIUS_KM = v;
      radiusBadge.textContent = `${CLICK_RADIUS_KM} km`;

      if (clickMarker) {
        const { lat, lng } = clickMarker.getLatLng();
        drawSelection(lat, lng);
        setCoords(lat, lng);
      } else {
        updatePayload(null, null);
        setUSABadge(null, null);
      }
      setURLFromState(clickMarker ? clickMarker.getLatLng().lat : null, clickMarker ? clickMarker.getLatLng().lng : null);
    });

    // sliders
    [elevRange, tempRange, humRange, tnRange, tpRange, fireRange].forEach((el) => {
      el.addEventListener("input", () => {
        updateFactorLabels();
        const lat = clickMarker ? clickMarker.getLatLng().lat : null;
        const lon = clickMarker ? clickMarker.getLatLng().lng : null;
        updatePayload(lat, lon);
        setURLFromState(lat, lon);
      });
    });

    // buttons
    document.getElementById("clearBtn").addEventListener("click", () => {
      clearSelection();
      explainBox.innerHTML = `<div class="hint">Click ‚ÄúPredict‚Äù to generate a demo explanation (placeholder until model/SHAP).</div>`;
      showToast("Cleared", "Selection removed.");
      setURLFromState(null, null);
    });

    document.getElementById("centerBtn").addEventListener("click", () => {
      map.setView(USA_CENTER, USA_ZOOM);
      showToast("Centered", "Moved back to USA view.");
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      // reset radius + sliders (keep location if it exists)
      CLICK_RADIUS_KM = DEFAULTS.radius_km;
      radiusInput.value = CLICK_RADIUS_KM;
      radiusBadge.textContent = `${CLICK_RADIUS_KM} km`;

      elevRange.value = DEFAULTS.elevation_m;
      tempRange.value = DEFAULTS.temperature_c;
      humRange.value  = DEFAULTS.humidity_pct;
      tnRange.value   = DEFAULTS.soil_tn;
      tpRange.value   = DEFAULTS.soil_tp;
      fireRange.value = DEFAULTS.fire_risk_index;
      updateFactorLabels();

      if (clickMarker) {
        const { lat, lng } = clickMarker.getLatLng();
        drawSelection(lat, lng);
        setCoords(lat, lng);
      } else {
        updatePayload(null, null);
      }

      explainBox.innerHTML = `<div class="hint">Defaults restored. Click ‚ÄúPredict‚Äù again.</div>`;
      showToast("Reset ‚úÖ", "Defaults restored.");
      setURLFromState(clickMarker ? clickMarker.getLatLng().lat : null, clickMarker ? clickMarker.getLatLng().lng : null);
    });

    document.getElementById("copyLinkBtn").addEventListener("click", copyShareLink);

    document.getElementById("predictBtn").addEventListener("click", () => {
      if (!clickMarker) {
        showToast("Pick a USA location first", "Click inside the blue boundary box.");
        return;
      }

      // loading skeleton
      renderExplainabilityLoading();
      showToast("Predicting‚Ä¶", "Demo mode: generating explanation.");

      // simulate API latency
      setTimeout(() => {
        renderExplainabilityResult();
        showToast("Done ‚úÖ", "Demo explanation generated.");
      }, 850);
    });

    // Load URL state if present
    loadStateFromURL();

    // Ensure payload matches current state on load
    const lat0 = clickMarker ? clickMarker.getLatLng().lat : null;
    const lon0 = clickMarker ? clickMarker.getLatLng().lng : null;
    updatePayload(lat0, lon0);
    setURLFromState(lat0, lon0);
  </script>
</body>
</html>
